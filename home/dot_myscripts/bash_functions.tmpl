# -*-mode:bash-*- vim:ft=bash

# ~/.bash_functions
# =============================================================================
# Shell functions sourced by `~/.bashrc` and `~/.zshrc`.

# shellcheck shell=bash

# General
# -----------------------------------------------------------------------------

# Extracts common file formats.
# Syntax: `extract <file1>`
# Source: https://github.com/xvoland/Extract
# TODO extract in named folder
function extract {
    if [ -z "$1" ]; then
        echo "Usage: extract <path/file_name>.<zip|rar|bz2|gz|tar|tbz2|tgz|Z|7z|xz|ex|tar.bz2|tar.gz|tar.xz>"
        echo "       extract <path/file_name_1.ext> [path/file_name_2.ext] [path/file_name_3.ext]"
        return 0
    fi

    for n in "$@"
    do
    if [ -f "$n" ] ; then
        case "${n%,}" in
            *.cbt|*.tar.bz2|*.tar.gz|*.tar.xz|*.tbz2|*.tgz|*.txz|*.tar)
                         tar xvf "$n"       ;;
            *.lzma)      unlzma ./"$n"      ;;
            *.bz2)       bunzip2 ./"$n"     ;;
            *.cbr|*.rar)       unrar x -ad ./"$n" ;;
            *.gz)        gunzip ./"$n"      ;;
            *.cbz|*.epub|*.zip)       unzip ./"$n"       ;;
            *.z)         uncompress ./"$n"  ;;
            *.7z|*.apk|*.arj|*.cab|*.cb7|*.chm|*.deb|*.dmg|*.iso|*.lzh|*.msi|*.pkg|*.rpm|*.udf|*.wim|*.xar)
                         7z x ./"$n"        ;;
            *.xz)        unxz ./"$n"        ;;
            *.exe)       cabextract ./"$n"  ;;
            *.cpio)      cpio -id < ./"$n"  ;;
            *.cba|*.ace)      unace x ./"$n"      ;;
            *.zpaq)      zpaq x ./"$n"      ;;
            *.arc)         arc e ./"$n"       ;;
            *.cso)       ciso 0 ./"$n" ./"$n.iso" && \
                              extract "$n".iso && \rm -f "$n" ;;
            *)
                         echo "extract: '$n' - unknown archive method"
                         return 1
                         ;;
        esac
    else
        echo "'$n' - file does not exist"
        return 1
    fi
    done
}
alias x=extract

# Searches history for a string, or lists all history.
# Syntax: `historysearch <string>`
function history_search() {
    if [ -z "$1" ]; then
        history
    else
        history | grep "$1"
    fi
}

# Searches session history for a string, or lists all session history.
# Syntax: `history_session_search <string>`
function history_session_search() {
    prefix=$(date +"$HISTTIMEFORMAT")
    offset=$((8 + ${#prefix}))
    comm -23 <(history | cut -c ${offset}-) "${HISTFILE:-'~/.bash_history'}" | grep "$1"
}

# Creates a directory and changes to it.
# Syntax: `mkcd <directory>`
function mkcd() {
    if [ -z "$1" ]; then
        echo "Usage: mkcd <path>"
        echo "Help: mkcd creates a directory if it doesn't exist, then changes to it."
        return 0
    fi

    mkdir -p -- "$@" && cd -P -- "$_" || exit;
}
alias take=mkcd

# Repeats a command a set number of times.
# Syntax: `repeat <count> <command>`
function repeat() {
    if [ -z "$1" ] || [ "$#" -lt 2 ]; then
        echo "Usage: repeat <count> <command> ..."
        echo "Help: repeat runs a command x number of times."
        return $#
    fi

    local i max
    max=$1; shift;
    for ((i=1; i <= max ; i++)); do
        eval "$@";
    done
}
alias r=repeat


# Sysadmin
# -----------------------------------------------------------------------------

# Keeps all apps and packages up to date.
# Syntax: `update`
function update() {
    echo "ðŸ”„ Starting system update..."
    local failed=()

    # macOS system updates
    if command -v softwareupdate &> /dev/null; then
        echo "â³ Checking for macOS updates..."
        if softwareupdate -l -i -a; then
            echo "âœ… macOS updated"
        else
            echo "âŒ macOS update failed"
            failed+=("macOS")
        fi
    fi

    # Homebrew updates
    if command -v brew &> /dev/null; then
        echo "â³ Updating Homebrew packages..."
        if brew update && brew upgrade && brew cleanup; then
            echo "âœ… Homebrew updated"
        else
            echo "âŒ Homebrew update failed"
            failed+=("Homebrew")
        fi
    fi

    # App Store updates
    if command -v mas &> /dev/null; then
        echo "â³ Updating App Store applications..."
        if mas upgrade; then
            echo "âœ… App Store updated"
        else
            echo "âŒ App Store update failed"
            failed+=("App Store")
        fi
    fi

    # APT updates (Debian/Ubuntu)
    if ! [[ "$OSTYPE" =~ ^darwin ]]; then
        if command -v apt &> /dev/null; then
            echo "â³ Updating apt packages..."
            if sudo apt update && sudo apt full-upgrade -y && sudo apt autoremove -y && sudo apt clean; then
                echo "âœ… APT updated"
            else
                echo "âŒ APT update failed"
                failed+=("APT")
            fi
        fi
    fi

    # Dotfiles update
    if command -v chezmoi &> /dev/null; then
        echo "â³ Updating dotfiles..."
        if chezmoi update; then
            echo "âœ… Dotfiles updated"
        else
            echo "âŒ Dotfiles update failed"
            failed+=("dotfiles")
        fi
    fi

    # NPM global packages
    if command -v npm &> /dev/null; then
        echo "â³ Updating npm global packages..."
        if npm update -g; then
            echo "âœ… NPM updated"
        else
            echo "âŒ NPM update failed"
            failed+=("NPM")
        fi
    fi

    # Summary
    echo ""
    if [ ${#failed[@]} -eq 0 ]; then
        echo "ðŸŽ‰ All updates completed successfully!"
    else
        echo "âš ï¸  Some updates failed: ${failed[*]}"
        return 1
    fi

    if command -v npm &> /dev/null; then
        echo 'Updating Node.js packages with npm...'
        which npm
        npm update -g
    fi

    if command -v npm &> /dev/null; then
        echo 'Updating Ruby gems...'
        which gem
        gem update --system
        gem update
        gem cleanup
    fi
}


# Applications
# -----------------------------------------------------------------------------

# Opens file/URL in Microsoft Edge.
# Syntax: `microsoft-edge <url>`
if [[ "$OSTYPE" =~ ^(cygwin|mingw|msys) ]]; then
    function microsoft-edge() {
        start microsoft-edge:"$1"
    }
fi


# Development
# -----------------------------------------------------------------------------

# Calls Python's pip3 at the global level.
if command -v pip3 > /dev/null; then
    function gpip3() {
        PIP_REQUIRE_VIRTUALENV="0" pip3 "$@"
    }
fi


# Varia
# -----------------------------------------------------------------------------

# Copies contents to the clipboard.
function cb() {
    if [ -z "$1" ]; then
        echo "Usage: cb <path>"
        echo "Help: cb copies a file contents to the clipboard."
        return 0
    fi

    if command -v pbcopy > /dev/null; then
        pbcopy < "$1"
    elif command -v xclip > /dev/null; then
        xclip -selection clipboard < "$1"
    elif command -v xsel > /dev/null; then
        xsel -ib < "$1"
    elif command -v clipboard > /dev/null; then # node.js clipboard-cli
        clipboard < "$1"
    elif command -v clip > /dev/null; then
        clip < "$1"
    elif command -v powershell > /dev/null; then
        powershell -NoProfile -Command "Set-Clipboard"
    fi
}

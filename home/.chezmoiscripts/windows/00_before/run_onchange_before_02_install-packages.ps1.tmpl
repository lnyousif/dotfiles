# PowerShell script to initialize setup for a Windows machine

Write-Host -ForegroundColor Cyan "Starting Windows machine setup..."

$ErrorActionPreference = "Continue"  # Don't stop on first error
$FailedPackages = @()

{{ range $setup, $value := .setups }}

  {{ if $value }}

        # Winget Packages
        {{- range index $.packages $setup "windows" "winget" -}}
            try {
                Write-Host -ForegroundColor Yellow "Installing {{ . }}..."
                winget install -e --disable-interactivity --silent --accept-source-agreements --accept-package-agreements --id {{ . | quote }}
                if ($LASTEXITCODE -eq 0) {
                    Write-Host -ForegroundColor Green "✓ {{ . }} installed successfully"
                } else {
                    Write-Host -ForegroundColor Red "✗ {{ . }} installation failed with exit code $LASTEXITCODE"
                    $FailedPackages += {{ . | quote }}
                }
            } catch {
                Write-Host -ForegroundColor Red "✗ Failed to install {{ . }}: $_"
                $FailedPackages += {{ . | quote }}
            }
        {{ end -}}

        {{- range index $.packages $setup "windows" "pips" -}}
            pip install {{ . | quote }}
        {{ end -}}

        {{ range index $.packages $setup "windows" "pnpm" }}
            pnpm install -g {{. | quote }}
        {{ end }}

  {{ end }}

{{ end }}



Write-Host -ForegroundColor Magenta "Windows machine setup completed."

if ($FailedPackages.Count -gt 0) {
    Write-Host -ForegroundColor Red "`n⚠️  Some packages failed to install:"
    $FailedPackages | ForEach-Object { Write-Host -ForegroundColor Red "  - $_" }
    exit 1
} else {
    Write-Host -ForegroundColor Green "`n✅ All packages installed successfully!"
}
